---
- name: ensure zsh is installed
  apt:
    name:
      - zsh
      - zsh-syntax-highlighting
      - zsh-autosuggestions
    state: present
  become: true
  tags: shell

- name: check if oh-my-zsh is already installed
  stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: omz_installed
  tags: shell

- name: install oh-my-zsh
  shell: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  when: not omz_installed.stat.exists
  tags: shell

- name: install zsh-autosuggestions plugin
  git:
    repo: https://github.com/zsh-users/zsh-autosuggestions
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
    update: false
  tags: shell

- name: install zsh-syntax-highlighting plugin
  git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
    update: false
  tags: shell

- name: ensure oh-my-zsh custom themes directory exists
  file:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes"
    state: directory
    mode: "0755"
  tags: shell

- name: install custom theme
  copy:
    src: triplea.zsh-theme
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/triplea.zsh-theme"
    mode: "0644"
    backup: true
  tags: shell

- name: set Zsh as default shell for current user
  become: true
  user:
    name: "{{ ansible_user_id }}"
    shell: /usr/bin/zsh
  tags: shell

- name: configure .zshrc to use my custom theme
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: "^ZSH_THEME="
    line: 'ZSH_THEME="triplea"'
    create: true
  tags: shell

- name: disable magic functions in .zshrc
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: "^DISABLE_MAGIC_FUNCTIONS="
    line: 'DISABLE_MAGIC_FUNCTIONS=true'
    create: true
  tags: shell

- name: ensure plugins are enabled in .zshrc
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: "^plugins="
    line: 'plugins=(zsh-autosuggestions zsh-syntax-highlighting)'
    create: true
  tags: shell

- name: ensure triplea.zsh is sourced in target system .zshrc
  blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    create: true
    marker: "# {mark} ANSIBLE MANAGED BLOCK - triplea.zsh"
    block: |
      # Source triplea.zsh for custom lab configuration
      [ -r "$HOME/.triplea.zsh" ] && . "$HOME/.triplea.zsh"
    insertafter: EOF
  tags: shell
